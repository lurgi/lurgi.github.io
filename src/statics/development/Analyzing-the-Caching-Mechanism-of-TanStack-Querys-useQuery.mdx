# Tanstack Queryì˜ useQuery ìºì‹± ë§¤ì»¤ë‹ˆì¦˜ ë¶„ì„í•˜ê¸°

í¬ë£¨ë£¨ ì„œë¹„ìŠ¤ì—ì„œ ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¡°ì‚¬ ê²°ê³¼, ì›ì¸ì€ TanStack Queryì˜ **Error ë°ì´í„° ìºì‹±**ìœ¼ë¡œ íŒë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ê³¼ì •ì—ì„œ ëª‡ ê°€ì§€ ì˜ë¬¸ì´ ë“¤ì—ˆê³ , ì´ë¥¼ íƒêµ¬í•˜ë©´ì„œ ì•Œê²Œ ëœ ë‚´ìš©ì„ ê³µìœ í•˜ê³ ì í•©ë‹ˆë‹¤.

## **â—ï¸ ë¬¸ì œ ìƒí™©**

ìš°ë¦¬ ì„œë¹„ìŠ¤ëŠ” TanStack Queryì˜ `staleTime`ì„ `0`ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì‚¬ìš©í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜, ì—ëŸ¬ê°€ ë°œìƒí–ˆì„ ë•Œ ì—¬ì „íˆ **ìºì‹±ëœ ì—ëŸ¬ ë°ì´í„°**ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì—ˆê³ , ì´ë¥¼ ë‹¤ì‹œ `throw`í•˜ëŠ” ë™ì‘ì„ ê´€ì°°í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

`staleTime`ì´ `0`ì´ë¼ë©´ ë°ì´í„°ê°€ ì¦‰ì‹œ "stale" ìƒíƒœë¡œ ê°„ì£¼ë˜ì–´ì•¼ í•˜ë¯€ë¡œ, ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ìš”ì²­í•´ì•¼ í•œë‹¤ê³  ìƒê°í–ˆì§€ë§Œ, ì‹¤ì œ ë™ì‘ì€ ë‹¤ë¥´ê²Œ ì´ë£¨ì–´ì¡ŒìŠµë‹ˆë‹¤.

## **â“Â ì™œ TanStack QueryëŠ” Error ë°ì´í„°ë¥¼ ìºì‹±í• ê¹Œ?**

TanStack Queryê°€ **Error ë°ì´í„°ë¥¼ ìºì‹±**í•˜ëŠ” ê²ƒì€ ê¸°ë³¸ì ì¸ ë™ì‘ì…ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì–»ì„ ìˆ˜ ìˆëŠ” ì´ì ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. **ë°ì´í„° ì‘ë‹µ ìºì‹±**
   - TanStack QueryëŠ” ì„œë²„ ìƒíƒœë¥¼ ìºì‹±í•˜ì—¬ ë°ì´í„°ë¥¼ ì¬ì‚¬ìš©í•˜ê³ , ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ì¤„ì´ëŠ” ë° ì¤‘ì ì„ ë‘” ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤.
   - ì´ëŠ” ë‹¨ìˆœíˆ ì„±ê³µì ì¸ ë°ì´í„° ì‘ë‹µë¿ë§Œ ì•„ë‹ˆë¼, ì—ëŸ¬ ì‘ë‹µë„ ë™ì¼í•˜ê²Œ ì ìš©ë©ë‹ˆë‹¤.
2. **ì‚¬ìš©ì ê²½í—˜(UX) í–¥ìƒ**
   - Optimistic UIë¥¼ ì œê³µí•˜ì—¬ \***\*ì‚¬ìš©ìê°€ ìš”ì²­ ìƒíƒœë¥¼ ë¹ ë¥´ê²Œ í™•ì¸í•˜ê³ , ìƒˆë¡œê³ ì¹¨ì´ë‚˜ ë°˜ë³µ ìš”ì²­ ì—†ì´ **ë¹ ë¥¸ í”¼ë“œë°±\*\*ì„ ë°›ì„ ìˆ˜ ìˆë„ë¡ ë•ìŠµë‹ˆë‹¤.
   - Optimistic UIë€ ìºì‹±ëœ ë°ì´í„°ë¥¼ í™œìš©í•˜ë©´ í™”ë©´ ì „í™˜ì´ë‚˜ ì¬ìš”ì²­ ì‹œ **ë¹ ë¥¸ ì´ˆê¸° ë¡œë”© ì†ë„**ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
   - ì—ëŸ¬ ë°ì´í„°ë„ ìºì‹±ë˜ì–´ **í˜„ì¬ ìƒíƒœë¥¼ ì¦‰ì‹œ í‘œì‹œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. **ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ê°ì†Œ**
   - ì—ëŸ¬ ë°œìƒ ì‹œ ë°˜ë³µì ìœ¼ë¡œ ë™ì¼í•œ ìš”ì²­ì„ ìˆ˜í–‰í•˜ì§€ ì•Šë„ë¡ ì„¤ê³„ë˜ì–´, ë„¤íŠ¸ì›Œí¬ ìì›ì„ ì ˆì•½í•©ë‹ˆë‹¤.

---

## **â“ë¬¸ì œì˜ í•µì‹¬, `staleTime`ì´ `0`ì¸ë°ë„ ìºì‹±ëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ **

ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ TanStack Queryì˜ `staleTime`ê³¼ `gcTime`ì˜ ë™ì‘ ì›ë¦¬ë¥¼ ì´í•´í•´ì•¼ í•©ë‹ˆë‹¤.

1. `staleTime`ê³¼ ìºì‹± ë°ì´í„°
   - `staleTime: 0`ì€ ì¿¼ë¦¬ ë°ì´í„°ê°€ "í•­ìƒ stale" ìƒíƒœë¡œ ê°„ì£¼ëœë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.
   - í•˜ì§€ë§Œ stale ìƒíƒœëŠ” **ë°ì´í„°ë¥¼ ìºì‹œì—ì„œ ì œê±°í•˜ëŠ” ê¸°ì¤€**ì´ ì•„ë‹™ë‹ˆë‹¤. ë°ì´í„°ë¥¼ ìºì‹œì—ì„œ ì½ì–´ì˜¤ê³ , ë™ì‹œì— ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ fetchí•˜ë„ë¡ ì‘ë™í•©ë‹ˆë‹¤.
2. `gcTime`ê³¼ ìºì‹œ ì œê±°
   - ì¿¼ë¦¬ê°€ êµ¬ë…ë˜ì§€ ì•ŠëŠ” ìƒíƒœì—ì„œ `gcTime`(ê¸°ë³¸ê°’: 5ë¶„)ì´ ì§€ë‚˜ì•¼ ë°ì´í„°ê°€ ìºì‹œì—ì„œ ì œê±°ë©ë‹ˆë‹¤.
   - ì¦‰, êµ¬ë… ì¤‘ì¸ ì¿¼ë¦¬ì˜ ë°ì´í„°ëŠ” stale ìƒíƒœë¼ë„ ì—¬ì „íˆ ìºì‹œì—ì„œ ìœ ì§€ë©ë‹ˆë‹¤.
   - gcì— ëŒ€í•´ì„œ ë” ìì„¸íˆ ì•Œê³  ì‹¶ë‹¤ë©´ â¤µï¸

   [ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ì •ë¦¬](https://lurgi.tistory.com/205)

3. Optimistic UIì™€ ìºì‹±ëœ ì—ëŸ¬ ë°ì´í„°
   - TanStack QueryëŠ” stale ìƒíƒœì—ì„œë„ ìºì‹±ëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ëŠ” ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ ìµœì í™”í•˜ê³ , ì‚¬ìš©ì ê²½í—˜ì„ ê°œì„ í•˜ë ¤ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì„¤ê³„ ì² í•™ì—ì„œ ë¹„ë¡¯ë©ë‹ˆë‹¤.
   - ë”°ë¼ì„œ, ì—ëŸ¬ê°€ ë°œìƒí•œ í›„ì—ë„ ìºì‹±ëœ ì—ëŸ¬ ë°ì´í„°ê°€ ì¦‰ì‹œ ì‚¬ìš©ë˜ë©°, ì´ë¥¼ `throw`í•˜ëŠ” ë™ì‘ì´ ì´ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ğŸš€Â useQueryì˜ Optimistic UI ë¡œì§ ë§¤ì»¤ë‹ˆì¦˜ì„ ì§ì ‘ ì½”ë“œë¥¼ ëœ¯ì–´ë³´ë©´ì„œ ì´í•´í•˜ê¸°

### 1ï¸âƒ£Â useQueryì˜ ê¸°ë³¸ ë™ì‘

ê¸°ë³¸ì ì¸ useQueryì˜ ê²°ê³¼ ê°’ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```tsx
export function useBaseQuery<
  TQueryFnData,
  TError,
  TData,
  TQueryData,
  TQueryKey extends QueryKey,
>(
  options: UseBaseQueryOptions<
    TQueryFnData,
    TError,
    TData,
    TQueryData,
    TQueryKey
  >,
  Observer: typeof QueryObserver,
  queryClient?: QueryClient
): QueryObserverResult<TData, TError> {
  //...

  const [observer] = React.useState(
    () =>
      new Observer<TQueryFnData, TError, TData, TQueryData, TQueryKey>(
        client,
        defaultedOptions
      )
  );

  const result = observer.getOptimisticResult(defaultedOptions);

  React.useSyncExternalStore(
    React.useCallback(
      (onStoreChange) => {
        const unsubscribe = isRestoring
          ? noop
          : observer.subscribe(notifyManager.batchCalls(onStoreChange));

        // Update result to make sure we did not miss any query updates
        // between creating the observer and subscribing to it.
        observer.updateResult();

        return unsubscribe;
      },
      [observer, isRestoring]
    ),
    () => observer.getCurrentResult(),
    () => observer.getCurrentResult()
  );
  //...
  if (
    getHasError({
      result,
      errorResetBoundary,
      throwOnError: defaultedOptions.throwOnError,
      query: client
        .getQueryCache()
        .get<
          TQueryFnData,
          TError,
          TQueryData,
          TQueryKey
        >(defaultedOptions.queryHash),
    })
  ) {
    throw result.error;
  }
  //...

  return !defaultedOptions.notifyOnChangeProps
    ? observer.trackResult(result)
    : result;
}
```

í•µì‹¬ì´ ë˜ëŠ” ì½”ë“œë¥¼ ê°„ì¶”ë ¤ ë³´ì•˜ìŠµë‹ˆë‹¤.

1. observerëŠ” useQueryì˜ ê¸°ì´ˆê°€ ë˜ëŠ” useBaseQueryì˜ ìƒíƒœê°’ìœ¼ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤.
2. resultê°’ì€ observer ìƒíƒœì˜ getOptimisticResultê°’ì„ ê°€ì§‘ë‹ˆë‹¤.
3. useSyncExternalStoreì— ì˜í•´ ì˜µì €ë²„ì˜ ìƒíƒœ ë³€ê²½ì„ ê°ì§€í•˜ê³  React ì»´í¬ë„ŒíŠ¸ë¥¼ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ resultê°’ì˜ ìµœì‹  ìƒíƒœë¥¼ ë°˜ì˜í•©ë‹ˆë‹¤.
4. getHasErrorê°€ ìˆëŠ” ê²½ìš° ê²°ê³¼ì ìœ¼ë¡œ result.errorë¥¼ Throwí•©ë‹ˆë‹¤.
5. ì•„ë‹ˆë¼ë©´ defaultedOptionsì— ë”°ë¼ observer.trackResult() í˜¹ì€ resultë¥¼ returní•©ë‹ˆë‹¤.

   (v4ë²„ì „ë¶€í„° notifyOnChangeProps ê¸°ë³¸ê°’ì€ â€œtrackedâ€ë¼ëŠ” truthy ê°’ì´ë¯€ë¡œ, ìš°ë¦¬ê°€ ë°›ëŠ” ê°’ì€ resultê°’ì…ë‹ˆë‹¤.)

### 2ï¸âƒ£Â ê·¸ëŸ¬ë©´ resultê°’ì€ ë­˜ê¹Œìš”?

```tsx
const [observer] = React.useState(
  () =>
    new Observer<TQueryFnData, TError, TData, TQueryData, TQueryKey>(
      client,
      defaultedOptions
    )
);

const result = observer.getOptimisticResult(defaultedOptions);
```

resultëŠ” observerì˜ getOptimisticResultë©”ì„œë“œì˜ ê²°ê³¼ê°’ì…ë‹ˆë‹¤. ë”°ë¼ì„œ QueryObserverë¥¼ ëœ¯ì–´ë³´ë„ë¡í•˜ê² ìŠµë‹ˆë‹¤.

[TanStack Query ê³µì‹ë¬¸ì„œ](https://github.com/TanStack/query/blob/main/packages/query-core/src/queryObserver.ts)

```tsx
getOptimisticResult(
    options: DefaultedQueryObserverOptions<
      TQueryFnData,
      TError,
      TData,
      TQueryData,
      TQueryKey
    >,
  ): QueryObserverResult<TData, TError> {
    const query = this.#client.getQueryCache().build(this.#client, options)

    const result = this.createResult(query, options)
//...
```

getOptimisticResultì˜ ê²°ê³¼ê°’ì€ createResult

ê¸°ë³¸ì ìœ¼ë¡œ creteResult í•¨ìˆ˜ì˜ ë°˜í™˜ê°’ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```tsx
const result: QueryObserverBaseResult<TData, TError> = {
  status,
  fetchStatus: newState.fetchStatus,
  isPending,
  isSuccess: status === "success",
  isError,
  isInitialLoading: isLoading,
  isLoading,
  data,
  dataUpdatedAt: newState.dataUpdatedAt,
  error,
  errorUpdatedAt,
  failureCount: newState.fetchFailureCount,
  failureReason: newState.fetchFailureReason,
  errorUpdateCount: newState.errorUpdateCount,
  isFetched: newState.dataUpdateCount > 0 || newState.errorUpdateCount > 0,
  isFetchedAfterMount:
    newState.dataUpdateCount > queryInitialState.dataUpdateCount ||
    newState.errorUpdateCount > queryInitialState.errorUpdateCount,
  isFetching,
  isRefetching: isFetching && !isPending,
  isLoadingError: isError && !hasData,
  isPaused: newState.fetchStatus === "paused",
  isPlaceholderData,
  isRefetchError: isError && hasData,
  isStale: isStale(query, options),
  refetch: this.refetch,
  promise: this.#currentThenable,
};

//...

const nextResult = result as QueryObserverResult<TData, TError>;
//...
return nextResult;
```

createReultì˜ ì½”ë“œë¥¼ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```tsx
//...
const { state } = query;
let newState = { ...state };
let isPlaceholderData = false;
let data: TData | undefined;

if (options._optimisticResults) {
  const mounted = this.hasListeners();

  const fetchOnMount = !mounted && shouldFetchOnMount(query, options);

  const fetchOptionally =
    mounted && shouldFetchOptionally(query, prevQuery, options, prevOptions);

  if (fetchOnMount || fetchOptionally) {
    newState = {
      ...newState,
      ...fetchState(state.data, query.options),
    };
  }
  if (options._optimisticResults === "isRestoring") {
    newState.fetchStatus = "idle";
  }
}
//...
```

í•´ë‹¹ ë¡œì§ì„ ì‚´í´ë³´ë©´, ë§ˆìš´íŠ¸ê°€ ëœ ì´í›„ ìƒˆë¡œ fetchë¥¼ ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ newStateì— ì¶”ê°€í•˜ëŠ” ë¡œì§ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1. fetchStateë¥¼ í†µí•´ ê¸°ì¡´ Observerdì—ì„œ fetchStateë¥¼ ë³€ê²½í•˜ì—¬ ì œê³µí•˜ëŠ” êµ¬ì¡°
2. ì´ë ‡ê²Œ Optimistic ìƒíƒœ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” í•©ë‹ˆë‹¤. ì¦‰ ê¸°ì¡´ ìºì‹œëœ ë°ì´í„°ê°€ ìˆê³ , ì´ ë°ì´í„°ì— ëŒ€í•œ fetchë¥¼ ì§„í–‰í–ˆë‹¤ë©´, ê¸°ì¡´ Queryì— stateë§Œ ë³€ê²½í•˜ì—¬ newStateë¥¼ ì œê³µí•˜ëŠ” í˜•ì‹ì„ ì˜ˆìƒí•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

### 3ï¸âƒ£Â staleTimeê³¼ gcTimeì— ë”°ë¼ì„œëŠ” ì–´ë–»ê²Œ ì‘ë™í• ê¹Œ?

Tanstack Queryì˜ ê¸°ë³¸ ì˜µì…˜ ê°’ì€ì€ staleTimeì˜ ê²½ìš° 0, gcTimeì˜ ê²½ìš° 5ë¶„ì…ë‹ˆë‹¤.

Tanstack Queryì˜ QueryëŠ” Removableì´ë€ ê°ì²´ë¥¼ í†µí•´ ë§Œë“¤ì–´ì ¸ìˆìŠµë‹ˆë‹¤.

Removableì€ gcTimeì„ ê´€ë¦¬í•˜ëŠ” ê°ì²´ì¸ë°ìš”, ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

[TanStack Query ê³µì‹ë¬¸ì„œ](https://github.com/TanStack/query/blob/main/packages/query-core/src/removable.ts)

```tsx
import { isServer, isValidTimeout } from "./utils";

export abstract class Removable {
  gcTime!: number;
  #gcTimeout?: ReturnType<typeof setTimeout>;

  destroy(): void {
    this.clearGcTimeout();
  }

  protected scheduleGc(): void {
    this.clearGcTimeout();

    if (isValidTimeout(this.gcTime)) {
      this.#gcTimeout = setTimeout(() => {
        this.optionalRemove();
      }, this.gcTime);
    }
  }

  protected updateGcTime(newGcTime: number | undefined): void {
    // Default to 5 minutes (Infinity for server-side) if no gcTime is set
    this.gcTime = Math.max(
      this.gcTime || 0,
      newGcTime ?? (isServer ? Infinity : 5 * 60 * 1000)
    );
  }

  protected clearGcTimeout() {
    if (this.#gcTimeout) {
      clearTimeout(this.#gcTimeout);
      this.#gcTimeout = undefined;
    }
  }

  protected abstract optionalRemove(): void;
}
```

setTimeoutì™€ optionalRemove ë©”ì„œë“œë¥¼ í†µí•´ì„œ ê°€ë¹„ì§€ ì»¬ë ‰íŒ…ì„ í•˜ëŠ” ëª¨ìŠµì„ ë³¼ ìˆ˜ ìˆëŠ”ë°ìš”, optionalRemoveë©”ì„œë“œëŠ” Query í´ë˜ìŠ¤ì—ì„œ ì˜¤ë²„ë¼ì´ë”©ì„ í†µí•´ êµ¬í˜„í•œ ëª¨ìŠµì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```tsx
//...
  protected optionalRemove() {
    if (!this.observers.length && this.state.fetchStatus === 'idle') {
      this.#cache.remove(this)
    }
  }
```

í•´ë‹¹ ì¿¼ë¦¬ì˜ ì˜µì €ë²„ê°€ ì¡´ì¬í•˜ì§€ ì•Šê³ , fetchStatusê°€ â€œidleâ€ì¸ ê²½ìš°, gcTimeì„ í†µí•´ cacheë¥¼ ì‚­ì œí•˜ëŠ” ê±¸ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ì¿¼ë¦¬ì˜ ì˜µì €ë²„ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì€ í•´ë‹¹ ì¿¼ë¦¬ë¥¼ êµ¬ë…í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.
- fetchStatusê°€ idleìƒíƒœë€ ê²ƒì€ ë„¤íŠ¸ì›Œí¬ ìš”ì²­(fetching)ì¤‘ì´ ì•„ë‹Œ ì•ˆì •ëœ ì¿¼ë¦¬ë¼ëŠ” ê²ƒì…ë‹ˆë‹¤.

ì§€ê¸ˆê¹Œì§€ ë‚´ìš©ìœ¼ë¡œ gcTimeì„ í†µí•´ ì¿¼ë¦¬ê°€ ì–´ë–»ê²Œ ìºì‹œë¥¼ ì‚­ì œí•˜ëŠ”ì§€ ì•Œì•˜ìŠµë‹ˆë‹¤.

staleTimeì€ cacheì˜ ìƒíƒœë¥¼ ê±´ë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¨ìˆœíˆ fetchStateë¥¼ ë³€ê²½í•¨ìœ¼ë¡œì¨ fetchì˜ ì‹¤í–‰ ì—¬ë¶€ë¥¼ ì„ íƒí•  ë¿ì…ë‹ˆë‹¤.

1. query.tsì˜ ì¿¼ë¦¬ê°€ stale ìƒíƒœì¸ì§€ íŒë‹¨í•˜ëŠ” ë©”ì„œë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```tsx
// Query.ts
// ...
isStale(): boolean {
    if (this.state.isInvalidated) {
      return true
    }

    if (this.getObserversCount() > 0) {
      return this.observers.some(
        (observer) => observer.getCurrentResult().isStale,
      )
    }

    return this.state.data === undefined
  }

  isStaleByTime(staleTime = 0): boolean {
    return (
      this.state.isInvalidated ||
      this.state.data === undefined ||
      !timeUntilStale(this.state.dataUpdatedAt, staleTime)
    )
  }

```

1. shouldFetchOnMountë©”ì„œë“œì™€ shouldFetchOnë‚´ë¶€ì—ì„œ staleê°’ì„ í†µí•´ fetch ì—¬ë¶€ë¥¼ íŒŒì•…í•˜ê²Œ ë©ë‹ˆë‹¤.

```tsx
// QueryObserver.ts
//...
function shouldFetchOnMount(
  query: Query<any, any, any, any>,
  options: QueryObserverOptions<any, any, any, any, any>
): boolean {
  return (
    shouldLoadOnMount(query, options) ||
    (query.state.data !== undefined &&
      shouldFetchOn(query, options, options.refetchOnMount))
  );
}

function shouldFetchOn(
  query: Query<any, any, any, any>,
  options: QueryObserverOptions<any, any, any, any, any>,
  field: (typeof options)["refetchOnMount"] &
    (typeof options)["refetchOnWindowFocus"] &
    (typeof options)["refetchOnReconnect"]
) {
  if (resolveEnabled(options.enabled, query) !== false) {
    const value = typeof field === "function" ? field(query) : field;

    return value === "always" || (value !== false && isStale(query, options));
  }
  return false;
}
```

1. onSubscribe í•¨ìˆ˜ ë‚´ë¶€ì—ì„  staleê°’ì„ í†µí•´ fetchì—¬ë¶€ë¥¼ ê²°ì •í•˜ê²Œ ë©ë‹ˆë‹¤.

```tsx
protected onSubscribe(): void {
    if (this.listeners.size === 1) {
      this.#currentQuery.addObserver(this)

      if (shouldFetchOnMount(this.#currentQuery, this.options)) {
        this.#executeFetch()
      } else {
        this.updateResult()
      }

      this.#updateTimers()
    }
}
```

## â—ï¸ê·¸ë˜ì„œ ë¬¸ì œê°€ ì¼ì–´ë‚œ ì´ìœ .

staleTimeì„ 0ìœ¼ë¡œ ì§€ì •í•˜ë”ë¼ë„, staleí•œ ê°’ì´ ì‚¬ë¼ì§€ëŠ” ê±´ ì•„ë‹™ë‹ˆë‹¤. Optimistic UIë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œ Tanstack QueryëŠ” ìš°ì„ ì ìœ¼ë¡œ ì´ì „ì˜ ìºì‹± ê°’ì„ ì‚¬ìš©í•˜ê²Œ ë©ë‹ˆë‹¤. ì´ ê°’ì´ staleí•œ ê°’ì´ì–´ë„ ì‚¬ìš©í•˜ê²Œ ë©ë‹ˆë‹¤. ë”°ë¼ì„œ ë©”ëª¨ë¦¬ë¥¼ ì™„ì „íˆ ì‚­ì œí•´ì£¼ëŠ” gcë¥¼ ì´ìš©í•´ ì‚­ì œë¥¼ í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ ì´ìƒ í•´ë‹¹ ê°’ì„ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

## ê²°ë¡ 

Tanstack Queryë¥¼ ì§ì ‘ ê¹Œë³´ë©´ì„œ, ë‚´ë¶€ ë™ì‘ì„ ì´í•´í•´ë´¤ìŠµë‹ˆë‹¤! ì‚¬ì‹¤ ì´ì „ì— Observer íŒ¨í„´ì— ëŒ€í•´ì„œ ê³µë¶€í•˜ë©° í•œë²ˆ ë¶„ì„í•œ ì ì´ ìˆì—ˆëŠ”ë°ìš”, ì´ëŠ” ì´ì „ ê¸€ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤!

[ì˜µì €ë²„ íŒ¨í„´(Observer Pattern)ê³¼ React Query](https://lurgi.tistory.com/170)

ì´ë²ˆ ë¶„ì„ì„ í†µí•´ì„œ Tanstack Queryì˜ ìºì‹± ë§¤ì»¤ë‹ˆì¦˜ì— ëŒ€í•´ì„œ ì´í•´ë„ê°€ ë†’ì•„ì¡ŒìŠµë‹ˆë‹¤.

ë¶„ì„í•˜ë©´ì„œ ëŠë‚€ê±´ ì½”ë“œë¥¼ ì–´ë–»ê²Œ ì‘ì„±í• ì§€ì— ëŒ€í•´ì„œ ì¡°ê¸ˆ ë” ê¹Šì´ê° ìˆê²Œ ê³µë¶€í•˜ë©´ ì¢‹ì„ ê²ƒ ê°™ë‹¨ ìƒê°ì´ ë“¤ì—ˆëŠ”ë°ìš”, íŠ¹íˆë‚˜ í´ë¼ì´ì–¸íŠ¸ì™€ ì§ì ‘ ë§ë‹¿ì§€ ì•ŠëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ ê°™ì€ ì˜ì—­ì—ì„  ì¤‘ìš”í•  ê²ƒì´ë¼ ìƒê°ì´ ë“¤ì—ˆì–´ìš”

ì˜ˆë¥¼ë“¤ì–´,

```tsx
const defaultedOptions = client.defaultQueryOptions(options);

(client.getDefaultOptions().queries as any)?._experimental_beforeQuery?.(
  defaultedOptions
);
```

ì´ë ‡ê²Œ ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ”ë° ì„¸ë¯¸ì½œë¡ ì´ ì™œ ì €ê¸°ìˆì§€? ì™€ ê°™ì€ ì˜ë¬¸ì´ ì¢…ì¢… ë“¤ì—ˆìŠµë‹ˆë‹¤.

ASI(Automatic Semicolon Insertion)ì˜ ì˜ë„ì¹˜ ì•Šì€ ë™ì‘ì„ ì˜ˆë°©í•˜ê¸° ìœ„í•´ì„œë¼ê³  í•˜ê³ , ì´ëŸ° ê²ƒë“¤ì„ ì•Œì•„ê°€ë©´ ì¡°ê¸ˆ ë” í´ë¦°í•œ ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ”ë° ë„ì›€ì´ ë  ê²ƒì´ë¼ ìƒê°ì´ ë“¤ì—ˆìŠµë‹ˆë‹¤~!
